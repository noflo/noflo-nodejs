#!/usr/bin/env node
// vim: set filetype=javascript:
var program = require('commander');
var fs = require('fs');
var http = require('http');
var https = require('https');
var lib = require('../index');
var noflo = require('noflo');
var runtime = require('noflo-runtime-websocket');
var flowhub = require('flowhub-registry');
var querystring = require('querystring');
var path = require('path');

var stored = lib.getStored();
var baseDir = process.env.PROJECT_HOME || process.cwd();
var interval = 10 * 60 * 1000;

program
  .version(lib.getLibraryConfig().version)
    .option('--graph <graph>', 'Path to a graph file to start', null)
    .option('--secure', 'use wss://', stored.secure)
    .parse(process.argv);

if (Object.keys(stored).length === 0) {
  console.error('No configuration found at ' + lib.getStoredPath() + '. Please run noflo-nodejs-init first.');
  process.exit(1);
}

var config = {
  label: stored.label,
  id: stored.id,
  user: stored.user,
  secret: stored.secret,
  protocol: 'websocket',
  type: 'noflo-nodejs'
};

config.secure = stored.secure || program.secure;
config.address = (config.secure ? 'wss://' : 'ws://') + stored.host + ':' + stored.port;

function serve(req, res) {
  res.write('OK') ;
  res.close();
}

function readSSLFile(fileName) {
  var file = path.resolve(process.cwd(), fileName);
  if (!fs.existsSync(file)) {
    console.error('Could not find ' + fileName);
    process.exit();
  } else {
    return fs.readFileSync(file);
  }
}

var flowhubRuntime = new flowhub.Runtime(config);

var startServer = function(defaultGraph) {
  var server;
  if (config.secure) {
    server = https.createServer({
     key: readSSLFile('ssl/key.pem'),
     cert: readSSLFile('ssl/cert.pem')
    }, serve);
  } else {
    server = http.createServer(serve);
  }
  var rt = runtime(server, {
    defaultGraph: defaultGraph,
    baseDir: baseDir,
    captureOutput: false,
    catchExceptions: true
  });

  server.listen(stored.port, function () {
    console.log('NoFlo runtime listening at ' + config.address);
    console.log('Using ' + baseDir + ' for component loading');

    var ide = stored.ide ||
      (config.secure ? 'https://' : 'http://') + 'app.flowhub.io';
    var params = querystring.escape('protocol=websocket&address=' + config.address);
    console.log('Live IDE URL: ' + ide + '#runtime/endpoint?' + params);

    // Register the runtime with Flowhub so that it will show up in the UI
    flowhubRuntime.register(function (err, ok) {
      if (err) {
        console.log('Registration with Flowhub failed: ' + err.message);
        return;
      }

      console.log('Registered with Flowhub. The Runtime should now be accessible in the UI');

      // Ping Flowhub periodically to let the user know that the
      // runtime is still available
      setInterval(function () {
        flowhubRuntime.ping();
      }, interval);
    });
  });
};

if (program.graph) {
  program.graph = path.resolve(process.cwd(), program.graph);
  console.log('Loading main graph: ' + program.graph);
  noflo.graph.loadFile(program.graph, function(graph) {
    startServer(graph);
  });
} else {
  startServer(null);
}
